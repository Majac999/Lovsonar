name: Lovsonar

on:
  schedule:
    - cron: '0 6 * * *'  # KjÃ¸rer kl 07:00 norsk tid hver morgen
  workflow_dispatch:      # Lar deg kjÃ¸re den manuelt for testing

jobs:
  scan:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: write
      
    steps:
    - uses: actions/checkout@v3
    
    - uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Installer
      run: pip install -r requirements.txt
      
    - name: Hent database
      uses: actions/cache@v3
      with:
        path: lovsonar_seen.db
        key: sonar-db-${{ github.run_id }}
        restore-keys: |
          sonar-db-
          
    - name: KjÃ¸r Sonar
      run: python lovsonar.py
      
    - name: Varsle via Issue
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          try {
            const data = JSON.parse(fs.readFileSync('nye_saker.json', 'utf8'));
            if (data.count > 0) {
              const body = data.items.map(i => 
                 `### ${i.type}: ${i.title}\n` +
                 `**Lenke:** [Les mer](${i.link})\n` +
                 (i.description ? `> ${i.description}\n` : '') + `\n---\n`
              ).join('\n');
              
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ðŸ“¡ Lovsonar treff: ${data.count} nye saker`,
                body: `Fant nye saker for deg:\n\n${body}`,
                labels: ['varsel']
              });
            }
          } catch (e) { console.log("Ingen nye saker funnet"); }
